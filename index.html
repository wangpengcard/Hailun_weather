<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åˆè®°å†œä¸š Â· ç‰ç±³ç§æ¤æ™ºèƒ½è¾…åŠ©</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root {
            --bg-body: #020617; --bg-panel: #1e293b; --text-main: #f8fcaf;
            --text-dim: #94a3b8; --accent: #3b82f6; --danger: #ef4444;
            --warning: #f59e0b; --success: #10b981; --neutral: #64748b;
        }
        * { box-sizing: border-box; }
        body, html { 
            margin: 0; padding: 0; width: 100vw; height: 100vh; 
            overflow: hidden; font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
            background: var(--bg-body); color: var(--text-main);
        }
        #app { display: flex; flex-direction: column; height: 100%; padding: 10px; gap: 10px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--bg-panel); padding: 10px 20px; border-radius: 8px; border-left: 4px solid var(--accent); }
        .conn-status { font-size: 12px; padding: 2px 8px; border-radius: 4px; }
        .status-on { background: rgba(16,185,129,0.2); color: var(--success); }
        .status-off { background: rgba(239,68,68,0.2); color: var(--danger); }
        .main-content { display: flex; flex: 1; gap: 10px; min-height: 0; }
        .left-panel { width: 300px; display: flex; flex-direction: column; gap: 10px; }
        .card { background: var(--bg-panel); border-radius: 8px; padding: 15px; flex: 1; display: flex; flex-direction: column; }
        .card-title { font-size: 14px; color: var(--text-dim); margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        select { background: #0f172a; color: #fff; border: 1px solid #334155; padding: 8px; border-radius: 4px; width: 100%; outline: none; }
        .stage-btn { padding: 8px; border: 1px solid #334155; border-radius: 4px; cursor: pointer; text-align: center; margin-bottom: 5px; font-size: 13px; transition: 0.3s; }
        .stage-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
        .right-panel { flex: 1; background: var(--bg-panel); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; }
        #chart { flex: 1; width: 100%; }
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .info-item { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; }
        .val { font-size: 18px; font-weight: bold; margin-top: 5px; display: block; }
        .unit { font-size: 12px; color: var(--text-dim); margin-left: 4px; }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div style="font-size: 20px; font-weight: bold; letter-spacing: 1px;">åˆè®°å†œä¸š Â· ç‰ç±³ç§æ¤æ™ºèƒ½è¾…åŠ© <span style="font-size: 12px; color: var(--accent);">v4.6 Public</span></div>
            <div :class="['conn-status', isConnected ? 'status-on' : 'status-off']">
                {{ isConnected ? 'â— æ•°æ®åŒæ­¥ä¸­' : 'â—‹ å·²æ–­å¼€' }}
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="card" style="flex: 0 0 auto;">
                    <div class="card-title">ğŸ“ é€‰æ‹©è§‚æµ‹ç‚¹</div>
                    <select v-model="selectedId">
                        <option v-for="t in towns" :key="t.id" :value="t.id">{{ t.name }}</option>
                    </select>
                </div>

                <div class="card" style="flex: 0 0 auto;">
                    <div class="card-title">ğŸ“… ç”Ÿè‚²é˜¶æ®µ (å½±å“é€†å¢ƒç®—æ³•)</div>
                    <div v-for="(name, key) in STAGES" :key="key" 
                         :class="['stage-btn', currentStage === key ? 'active' : '']"
                         @click="currentStage = key">
                        {{ name }}
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">âš ï¸ å½“å‰é€†å¢ƒåˆ†æ</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <span style="font-size: 12px; color: var(--text-dim);">å®æ—¶æ¸©åº¦</span>
                            <span class="val">{{ currentData.temp || '--' }}<span class="unit">Â°C</span></span>
                        </div>
                        <div class="info-item">
                            <span style="font-size: 12px; color: var(--text-dim);">é™æ°´æ¦‚ç‡</span>
                            <span class="val">{{ currentData.pop || '0' }}<span class="unit">%</span></span>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: rgba(239,68,68,0.1); border-radius: 6px; border-left: 3px solid var(--danger);">
                        <div style="font-size: 12px; color: var(--danger);">å¼‚å¸¸æé†’</div>
                        <div style="font-size: 13px; margin-top: 5px;">{{ riskMessage }}</div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="card-title">ğŸ“ˆ æœªæ¥ 48 å°æ—¶ç¯å¢ƒè¶‹åŠ¿é¢„æµ‹ (åŒè½´å›¾)</div>
                <div id="chart"></div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, watch, computed } = Vue;

        createApp({
            setup() {
                const isConnected = ref(false);
                const towns = ref([]);
                const selectedId = ref('');
                const realtimeMap = ref({});
                const forecastMap = ref({});
                const currentStage = ref('seedling');
                const isLocked = ref(false);

                // --- å…³é”®æ”¹é€ ç‚¹ï¼šä½¿ç”¨å…¬å¼€ä»“åº“çš„ Raw é“¾æ¥ ---
                // æ›¿æ¢ä¸‹é¢ä¸¤ä¸ªè¯ï¼š'ä½ çš„ç”¨æˆ·å', 'ä½ çš„ä»“åº“å'
                const base = "https://raw.githubusercontent.com/wangpengcard/Hailun_weather/main";

                const STAGES = { seedling: 'å‡ºè‹—æ‹”èŠ‚æœŸ', tasseling: 'æŠ½é›„åä¸æœŸ', grain: 'çŒæµ†æˆç†ŸæœŸ' };

                const fetchData = async () => {
                    try {
                        const ts = `?t=${Date.now()}`;
                        // æ”¹é€ ï¼šç›´æ¥ GET è¯·æ±‚ï¼Œæ— éœ€ Headersï¼Œæ—  1MB é™åˆ¶
                        const [tRes, rRes, fRes] = await Promise.all([ 
                            axios.get(`${base}/towns.csv${ts}`), 
                            axios.get(`${base}/2026.json${ts}`), 
                            axios.get(`${base}/forecasts.json${ts}`)
                        ]);

                        // æ”¹é€ ï¼šPublic ä»“åº“ç›´æ¥è¿”å›æ–‡æœ¬/JSONï¼Œæ— éœ€ base64 è§£ç 
                        towns.value = tRes.data.split('\n').slice(1)
                            .filter(r => r.includes(','))
                            .map(r => ({ name: r.split(',')[1].trim(), id: r.split(',')[2].trim() }));
                        
                        // é€‚é…ä¸åŒçš„è¿”å›æ ¼å¼
                        realtimeMap.value = typeof rRes.data === 'object' ? rRes.data : JSON.parse(rRes.data); 
                        forecastMap.value = typeof fRes.data === 'object' ? fRes.data : JSON.parse(fRes.data);

                        if(towns.value.length > 0) { 
                            isConnected.value = true; 
                            if(!selectedId.value) selectedId.value = towns.value[0].id; 
                        }
                    } catch (e) { 
                        console.error("è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»“åº“ visibility:", e);
                        isConnected.value = false; 
                    }
                };

                const currentData = computed(() => {
                    const list = realtimeMap.value[selectedId.value] || [];
                    return list.length > 0 ? list[list.length - 1] : {};
                });

                const riskMessage = computed(() => {
                    if(!currentData.value.temp) return "æš‚æ— æ•°æ®åŒæ­¥";
                    const t = currentData.value.temp;
                    if(t < 10) return "ä½æ¸©é¢„è­¦ï¼šå½“å‰æ¸©åº¦ä½äºç‰ç±³ç”Ÿé•¿åŸºç‚¹ã€‚";
                    if(t > 35) return "é«˜æ¸©é¢„è­¦ï¼šæ³¨æ„æ°´åˆ†è’¸è…¾ï¼Œé¢„é˜²æ—±æƒ…ã€‚";
                    return "ç¯å¢ƒæ­£å¸¸ï¼šå½“å‰æ°”è±¡æ¡ä»¶é€‚åˆç‰ç±³ç”Ÿé•¿ã€‚";
                });

                let myChart = null;
                const renderChart = (data) => {
                    if(!myChart) myChart = echarts.init(document.getElementById('chart'), 'dark');
                    const option = {
                        backgroundColor: 'transparent',
                        tooltip: { trigger: 'axis' },
                        legend: { data: ['æ¸©åº¦', 'é™æ°´æ¦‚ç‡'] },
                        xAxis: { type: 'category', data: data.map(d => d.time) },
                        yAxis: [
                            { type: 'value', name: 'æ¸©åº¦(Â°C)', position: 'left' },
                            { type: 'value', name: 'æ¦‚ç‡(%)', position: 'right', max: 100 }
                        ],
                        series: [
                            { name: 'æ¸©åº¦', type: 'line', data: data.map(d => d.temp), smooth: true, color: '#3b82f6' },
                            { name: 'é™æ°´æ¦‚ç‡', type: 'bar', yAxisIndex: 1, data: data.map(d => d.pop), color: '#1e40af' }
                        ]
                    };
                    myChart.setOption(option);
                };

                watch(selectedId, (id) => { 
                    renderChart(forecastMap.value[id] || []); 
                });

                onMounted(() => {
                    fetchData();
                    setInterval(fetchData, 300000); // 5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
                    window.onresize = () => myChart && myChart.resize();
                });

                return { isConnected, towns, selectedId, STAGES, currentStage, currentData, riskMessage };
            }
        }).mount('#app');
    </script>
</body>
</html>