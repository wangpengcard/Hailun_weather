<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç‰ç±³ç§æ¤ç¯å¢ƒé€†å¢ƒé¢„æµ‹çœ‹æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root {
            --bg-body: #020617; --bg-panel: #1e293b; --text-main: #f8fcaf;
            --text-dim: #94a3b8; --accent: #3b82f6; --danger: #ef4444;
            --warning: #f59e0b; --success: #10b981; --neutral: #64748b;
        }
        * { box-sizing: border-box; }
        body, html { 
            margin: 0; padding: 0; width: 100vw; height: 100vh; 
            overflow: hidden; font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
            background: var(--bg-body); color: var(--text-main);
        }
        #app { display: flex; flex-direction: column; height: 100vh; width: 100vw; }
        header { 
            height: 45px; flex-shrink: 0; background: #000; 
            border-bottom: 1px solid #334155; display: flex; 
            align-items: center; padding: 0 15px; justify-content: space-between; 
        }
        main { flex: 1; display: flex; overflow: hidden; }
        aside { 
            width: 250px; flex-shrink: 0; background: var(--bg-panel); 
            border-right: 1px solid #334155; display: flex; flex-direction: column; 
            padding: 15px; gap: 15px;
        }
        .select-group label { display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 5px; }
        .select-row { display: flex; align-items: center; gap: 5px; }
        select { 
            flex: 1; padding: 8px; background: #0f172a; color: #fff; 
            border: 1px solid #334155; border-radius: 4px; font-size: 13px; 
            outline: none; cursor: pointer; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C2.185 5.355 2.403 5 2.801 5h10.398c.398 0 .616.355.35.658l-4.796 5.482a.5.5 0 0 1-.708 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 10px center;
        }
        .fix-btn { width: 32px; height: 32px; background: #334155; border: none; border-radius: 4px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .fix-btn:hover { background: #475569; }
        .calendar { background: #0f172a; border-radius: 8px; padding: 10px; border: 1px solid #475569; }
        .cal-head { display: flex; gap: 5px; margin-bottom: 10px; }
        .cal-head select { padding: 4px; font-size: 11px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; font-size: 10px; }
        .cal-date { height: 24px; line-height: 24px; position: relative; cursor: pointer; }
        .cal-date.active { background: var(--accent); color: #fff; border-radius: 2px; }
        .cal-date.has-risk::after { 
            content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; background: var(--danger); border-radius: 50%;
        }
        .cal-date.empty { cursor: default; }
        .diag-box {
            flex: 1; background: rgba(15, 23, 42, 0.6); 
            border-radius: 8px; border: 1px dashed #334155;
            padding: 10px; overflow-y: auto; font-size: 11px; line-height: 1.6;
        }
        .diag-box::-webkit-scrollbar { width: 4px; }
        .diag-box::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        .diag-item { margin-bottom: 8px; padding-left: 10px; border-left: 2px solid var(--accent); }
        .diag-danger { border-left-color: var(--danger); color: #fda4af; }
        .diag-warning { border-left-color: var(--warning); color: #fde047; }
        .diag-success { border-left-color: var(--success); color: #6ee7b7; }
        .content { flex: 1; display: flex; flex-direction: column; padding: 15px; gap: 10px; overflow: hidden; }
        .dashboard { 
            display: grid; grid-template-columns: repeat(7, 1fr); 
            gap: 10px; background: #0f172a; padding: 12px; 
            border-radius: 8px; border: 1px solid #334155; flex-shrink: 0;
        }
        .light-box { text-align: center; }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin: 0 auto 5px; background: #334155; }
        .dot.active { box-shadow: 0 0 10px currentColor; }
        .l-txt { font-size: 11px; margin-bottom: 2px; }
        .l-msg { font-size: 10px; color: var(--text-dim); }
        #chart-main { flex: 1; background: #000; border-radius: 8px; border: 1px solid #334155; cursor: crosshair; }
        .param-grid { 
            background: var(--bg-panel); border-radius: 8px; border: 1px solid #334155; 
            padding: 10px; display: grid; grid-template-columns: repeat(9, 1fr); gap: 8px;
            flex-shrink: 0;
        }
        .p-card { text-align: center; border-right: 1px dotted #334155; overflow: hidden; min-width: 0; }
        .p-card:nth-child(9n) { border-right: none; }
        .p-lab { font-size: 10px; color: var(--text-dim); margin-bottom: 3px; white-space: nowrap; }
        .p-val { font-size: 11px; font-weight: bold; color: var(--text-main); white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        
        .modal-mask { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:9999; }
        .modal-win { background:var(--bg-panel); padding:20px; border-radius:8px; border:1px solid var(--accent); width:300px; }
    </style>
</head>
<body>

<div id="app">
    <header>
        <div style="font-weight: bold; color: var(--accent);">ç‰ç±³ç§æ¤ç¯å¢ƒé€†å¢ƒé¢„æµ‹çœ‹æ¿</div>
        <div style="font-size: 12px; color: var(--text-dim);">
            çŠ¶æ€: <span :style="{color: isConnected ? 'var(--success)' : 'var(--danger)'}">{{ isConnected ? 'â— å·²è¿æ¥' : 'â—‹ å°è¯•åŒæ­¥æ•°æ®...' }}</span>
            <span v-if="isLocked" style="margin-left:10px; color:var(--warning)">[ æŒ‡ç¤ºçº¿å·²é”å®š ]</span>
        </div>
    </header>

    <main>
        <aside>
            <div class="select-group">
                <label>ç›‘æµ‹åœ°ç‚¹</label>
                <select v-model="selectedId">
                    <option v-for="t in towns" :key="t.id" :value="t.id">{{ t.name }}</option>
                </select>
            </div>
            <div class="select-group">
                <label>ç‰ç±³ç”Ÿé•¿é˜¶æ®µ</label>
                <div class="select-row">
                    <select v-model="currentStage">
                        <option v-for="s in stageList" :key="s" :value="s">{{ s }}{{ hasManualLock(s) ? ' ğŸ”’' : '' }}</option>
                    </select>
                    <button class="fix-btn" @click="showFixModal = true" title="æ ¡æ­£è¿›å…¥æ—¥æœŸ">ğŸ¯</button>
                </div>
            </div>
            <div class="calendar">
                <div class="cal-head">
                    <select v-model="viewYear"><option v-for="y in [2025,2026]" :value="y">{{y}}å¹´</option></select>
                    <select v-model="viewMonth"><option v-for="m in 12" :value="m-1">{{m}}æœˆ</option></select>
                </div>
                <div class="cal-grid">
                    <div style="color:var(--text-dim)" v-for="d in ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥']" :key="d">{{ d }}</div>
                    <div v-for="(day, idx) in calDays" :key="idx" @click="clickCalDate(day)" :class="['cal-date', day.type === 'empty' ? 'empty' : '', day.isToday ? 'active' : '', day.hasRisk ? 'has-risk' : '']"> {{ day.val }} </div>
                </div>
            </div>
            <div class="diag-box">
                <div v-if="!isConnected" class="diag-item">æ­£åœ¨åŒæ­¥ GitHub æœ€æ–°é‡‡é›†æ•°æ®...</div>
                <div v-else-if="diagMsgs.length === 0" class="diag-item diag-success">å½“å‰ç¯å¢ƒå‚æ•°ç†æƒ³ã€‚</div>
                <div v-for="msg in diagMsgs" :key="msg.text" :class="['diag-item', msg.type]"> {{ msg.text }} </div>
            </div>
            <div style="font-size:10px; color:var(--text-dim); line-height:1.5;"> * æ ¸å¿ƒé€»è¾‘ï¼šD30ç›ˆäº+Stresså€’ä¼æ¨¡å‹<br> * æ¨¡å¼ï¼šGitHub Pages å…¬å¼€éƒ¨ç½²ç‰ˆ </div>
        </aside>

        <div class="content">
            <div class="dashboard">
                <div class="light-box" v-for="l in risks" :key="l.name">
                    <div class="l-txt">{{ l.name }}</div>
                    <div :class="['dot', isConnected ? 'active' : '']" :style="{ color: isConnected ? l.color : '#334155', background: 'currentColor' }"></div>
                    <div class="l-msg">{{ isConnected ? l.status : '--' }}</div>
                </div>
            </div>
            <div id="chart-main"></div>
            <div class="param-grid">
                <div class="p-card"><div class="p-lab">æ¸©åº¦</div><div class="p-val">{{ sel.temp ?? '--' }}Â°C</div></div>
                <div class="p-card"><div class="p-lab">é™é›¨é‡</div><div class="p-val">{{ sel.rain ?? '0' }}mm</div></div>
                <div class="p-card"><div class="p-lab">é£é€Ÿ</div><div class="p-val">{{ sel.wind_speed ?? '--' }} m/s</div></div>
                <div class="p-card"><div class="p-lab">é£åŠ›</div><div class="p-val">{{ sel.wf || '--' }}</div></div>
                <div class="p-card"><div class="p-lab">é£å‘</div><div class="p-val"> <span v-if="sel.dir" :style="{display:'inline-block', transform:'rotate('+sel.wind_deg+'deg)'}">â†“</span> {{ sel.dir || '--' }} </div></div>
                <div class="p-card"><div class="p-lab">é˜µé£</div><div class="p-val">{{ sel.wind_gust ?? '--' }} m/s</div></div>
                <div class="p-card"><div class="p-lab">ç›¸å¯¹æ¹¿åº¦</div><div class="p-val">{{ sel.humidity ?? '--' }}%</div></div>
                <div class="p-card"><div class="p-lab">éœ²ç‚¹æ¸©åº¦</div><div class="p-val">{{ sel.dew_point ?? '--' }}Â°C</div></div>
                <div class="p-card"><div class="p-lab">D30ç›ˆäº</div><div class="p-val">{{ sel.d30 || '--' }}</div></div>
                <div class="p-card"><div class="p-lab">å¤©æ°”å®å†µ</div><div class="p-val">{{ sel.weather_desc || '--' }}</div></div>
                <div class="p-card"><div class="p-lab">ç´«å¤–çº¿æŒ‡æ•°</div><div class="p-val">{{ sel.uvi ?? '--' }}</div></div>
                <div class="p-card"><div class="p-lab">èƒ½è§åº¦</div><div class="p-val">{{ sel.visibility ? sel.visibility + 'm' : '--' }}</div></div>
                <div class="p-card"><div class="p-lab">äº‘é‡</div><div class="p-val">{{ sel.clouds ?? '--' }}%</div></div>
                <div class="p-card"><div class="p-lab">å¤§æ°”å‹</div><div class="p-val">{{ sel.pressure ? sel.pressure + 'hPa' : '--' }}</div></div>
                <div class="p-card"><div class="p-lab">é™é›ª</div><div class="p-val">{{ sel.snow ?? '0' }}mm</div></div>
                <div class="p-card"><div class="p-lab">æ—¶é—´ç‚¹</div><div class="p-val">{{ sel.time || '--' }}</div></div>
                <div class="p-card"><div class="p-lab">æ—¥æœŸ</div><div class="p-val">{{ sel.date || '--' }}</div></div>
                <div class="p-card"><div class="p-lab">æ•°æ®çŠ¶æ€</div><div class="p-val">{{ sel.flag_desc || '--' }}</div></div>
            </div>
        </div>
    </main>

    <div v-if="showFixModal" class="modal-mask">
        <div class="modal-win">
            <h4 style="margin:0 0 15px 0">ç¡®è®¤è¿›å…¥ {{currentStage}} çš„æ—¥æœŸ</h4>
            <div style="margin-bottom:15px">
                <input type="date" v-model="fixDate" style="width:100%; padding:8px; background:#000; color:#fff; border:1px solid #334155">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px">
                <button @click="showFixModal = false" style="padding:5px 15px; background:#475569; border:none; color:white">å–æ¶ˆ</button>
                <button @click="saveManualFix" style="padding:5px 15px; background:var(--accent); border:none; color:white">ç¡®å®š</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, onMounted, reactive, watch, computed } = Vue;

createApp({
    setup() {
        const isConnected = ref(false);
        const isLocked = ref(false);
        const base = "."; 
        
        const towns = ref([]);
        const selectedId = ref('');
        const realtimeMap = ref({});
        const forecastMap = ref({});
        const manualFixes = ref(JSON.parse(localStorage.getItem('corn_fixes') || '[]'));
        const diagMsgs = ref([]); 

        const stageList = ["æ’­ç§æœŸ", "VE", "V1", "V2", "V3", "V4", "V5", "V6æ‹”èŠ‚", "V7", "V8", "V9", "V10", "V11", "V12å¤§å–‡å­å£", "V13", "V14", "V15", "V16", "V17", "V18", "V19", "VTæŠ½ç©—", "R1åä¸", "R2æ°´æ³¡", "R3ä¹³ç†Ÿ", "R4èœ¡ç†Ÿ", "R5å‡¹é™·", "R6å®Œç†Ÿ"];
        const currentStage = ref("V12å¤§å–‡å­å£");
        // æ–‡æ¡£æ˜ å°„çš„Kcå€¼ 
        const kcConfig = { "æ’­ç§æœŸ":0.3, "VE":0.45, "V6æ‹”èŠ‚":0.75, "V12å¤§å–‡å­å£":0.95, "VTæŠ½ç©—":1.2, "R2æ°´æ³¡":1.1, "R4èœ¡ç†Ÿ":0.9, "R6å®Œç†Ÿ":0.6 };
        
        const now = new Date();
        const viewYear = ref(now.getFullYear());
        const viewMonth = ref(now.getMonth());
        
        const showFixModal = ref(false);
        const fixDate = ref(now.toISOString().split('T')[0]);

        const sel = reactive({ 
            temp:null, rain:null, wind_speed:null, wind_gust:null, dir:null, wind_deg:0, 
            humidity:null, pressure:null, dew_point:null, weather_desc:null, uvi:null, 
            visibility:null, clouds:null, snow:null, wf:null, flag_desc:null, 
            time:null, date:null, d30: null 
        });

        const risks = ref([ 
            {name:'å¹²æ—±', color:'#64748b', status:'ç»Ÿè®¡ä¸­'}, 
            {name:'é«˜æ¸©', color:'#10b981', status:'æ­£å¸¸'}, 
            {name:'ä½æ¸©', color:'#64748b', status:'ç»Ÿè®¡ä¸­'}, 
            {name:'å€’ä¼', color:'#10b981', status:'ä½é£é™©'}, 
            {name:'æ°´æ¶', color:'#10b981', status:'æ­£å¸¸'}, 
            {name:'ç—…è™«å®³', color:'#10b981', status:'å¹³ç¨³'}, 
            {name:'é£é˜²è¯„åˆ†', color:'#64748b', status:'-'} 
        ]);

        let chart = null;

        const getWindDirText = (deg) => {
            if (deg === null || deg === undefined) return null;
            const val = Math.floor((deg / 22.5) + 0.5);
            const arr = ["åŒ—", "åŒ—ä¸œåŒ—", "ä¸œåŒ—", "ä¸œä¸œåŒ—", "ä¸œ", "ä¸œä¸œå—", "ä¸œå—", "å—ä¸œå—", "å—", "å—è¥¿å—", "è¥¿å—", "è¥¿è¥¿å—", "è¥¿", "è¥¿è¥¿åŒ—", "è¥¿åŒ—", "åŒ—è¥¿åŒ—"];
            return arr[(val % 16)] + "é£";
        };

        const getBeaufort = (ms) => {
            if (ms === null || ms === undefined) return null;
            if (ms < 0.3) return 0; if (ms < 1.6) return 1; if (ms < 3.4) return 2; if (ms < 5.5) return 3;
            if (ms < 8.0) return 4; if (ms < 10.8) return 5; if (ms < 13.9) return 6; if (ms < 17.2) return 7;
            if (ms < 20.8) return 8; if (ms < 24.5) return 9; if (ms < 28.5) return 10; if (ms < 32.7) return 11;
            return 12;
        };

        const calDays = computed(() => {
            const first = new Date(viewYear.value, viewMonth.value, 1);
            let startOffset = first.getDay(); 
            startOffset = startOffset === 0 ? 6 : startOffset - 1;
            const total = new Date(viewYear.value, viewMonth.value + 1, 0).getDate();
            const days = [];
            for (let i = 0; i < startOffset; i++) days.push({ type: 'empty' });
            const townData = [...(realtimeMap.value[selectedId.value] || []), ...(forecastMap.value[selectedId.value] || [])];
            for (let i = 1; i <= total; i++) {
                const dateStr = `${viewYear.value}-${String(viewMonth.value + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const dayData = townData.filter(d => d.date === dateStr);
                const hasRisk = dayData.some(d => (d.wind_gust || d.wind_speed || 0) > 10.8 || d.temp >= 32);
                days.push({ val: i, type: 'day', dateStr, isToday: dateStr === now.toISOString().split('T')[0], hasRisk, dayData });
            }
            return days;
        });

        const hasManualLock = (stage) => manualFixes.value.some(f => f.townId === selectedId.value && f.stage === stage);

        const saveManualFix = () => {
            const idx = manualFixes.value.findIndex(f => f.townId === selectedId.value && f.stage === currentStage.value);
            if(idx > -1) manualFixes.value[idx].date = fixDate.value;
            else manualFixes.value.push({ townId: selectedId.value, stage: currentStage.value, date: fixDate.value });
            localStorage.setItem('corn_fixes', JSON.stringify(manualFixes.value));
            showFixModal.value = false;
            resetToRealtime();
        };

        const clickCalDate = (day) => {
            if (!day.val || !day.dayData || day.dayData.length === 0) return;
            let msg = `ã€å†å²å›æº¯ã€‘${day.dateStr}ï¼š`;
            if (day.hasRisk) {
                const peakWind = day.dayData.sort((a,b) => (b.wind_gust||0) - (a.wind_gust||0))[0];
                const peakTemp = day.dayData.sort((a,b) => (b.temp||0) - (a.temp||0))[0];
                if((peakWind.wind_gust||0) > 10.8) msg += `å¤§é£é£é™©(${getBeaufort(peakWind.wind_gust)}çº§)ï¼›`;
                if(peakTemp.temp >= 32) msg += `é«˜æ¸©é£é™©(${peakTemp.temp}â„ƒ)ï¼›`;
            } else msg += `ç¯å¢ƒæ•°æ®å¹³ç¨³ï¼Œæ— å¼‚å¸¸ã€‚`;
            diagMsgs.value = [{ type: day.hasRisk ? 'diag-danger' : 'diag-success', text: msg }];
        };

        const renderChart = (data = []) => {
            if(!chart) chart = echarts.init(document.getElementById('chart-main'), 'light');
            if(data.length === 0) return;
            chart.setOption({
                title: { text: 'æœªæ¥è¶‹åŠ¿é¢„æµ‹ (æ‚¬åœæŸ¥çœ‹è¯¦æƒ…)', textStyle: {color: '#94a3b8', fontSize: 11}, left: 10, top: 10 },
                tooltip: { trigger: 'axis' },
                grid: { top: 60, bottom: 30, left: 45, right: 45 },
                xAxis: { 
                    type: 'category', 
                    data: data.map(d => d.time), 
                    axisLabel: {color:'#94a3b8', fontSize:10} 
                },
                yAxis: [
                    { type:'value', name:'Â°C', axisLabel:{color:'#94a3b8'}, splitLine: { show: true, lineStyle: { color: '#334155', type: 'dashed' } } },
                    { type:'value', name:'mm', position:'right', min: 0, splitLine: { show: false } }
                ],
                legend: { data: ['é¢„æµ‹æ¸©åº¦', 'é¢„æµ‹é™é›¨'], textStyle: { color: '#94a3b8' } },
                series: [
                    { name:'é¢„æµ‹æ¸©åº¦', type:'line', data:data.map(d => d.temp), smooth:true, itemStyle:{color:'#3b82f6'} },
                    { name:'é¢„æµ‹é™é›¨', type:'bar', yAxisIndex:1, data:data.map(d => d.rain || 0), itemStyle:{color:'#006400', opacity: 0.6} }
                ]
            });

            chart.getZr().off('click');
            chart.getZr().on('click', (params) => {
                const point = [params.offsetX, params.offsetY];
                if (chart.containPixel('grid', point)) isLocked.value = !isLocked.value;
                else { isLocked.value = false; resetToRealtime(); }
            });

            chart.on('updateAxisPointer', (event) => {
                if (isLocked.value) return;
                const p = event.axesInfo && event.axesInfo[0];
                if (p && p.value !== undefined) {
                    const item = data[p.value];
                    if (item) { updateDetail(item); judgeRisks(item); }
                }
            });
        };

        // æ ¸å¿ƒä¼˜åŒ–ï¼šé€†å¢ƒåˆ¤å®šæ¨¡å‹ 
        const judgeRisks = (currentItem) => {
            if(!currentItem) return;
            let msgs = [];
            const fullSeries = (realtimeMap.value[selectedId.value] || [])
                .sort((a,b) => new Date(a.date+' '+a.time) - new Date(b.date+' '+b.time));
            const idx = fullSeries.findIndex(item => item.date === currentItem.date && item.time === currentItem.time);
            if(idx === -1) return;
            const getPastData = (hrs) => fullSeries.slice(Math.max(0, idx - hrs), idx + 1);

            // 1. å¹²æ—±èƒè¿« (D30 - å¡åœ°æ°´åˆ†å¹³è¡¡æ¨¡å‹) 
            const d30Window = getPastData(720); 
            if (d30Window.length < 120) {
                risks.value[0].status = 'ç§¯ç´¯ä¸­'; risks.value[0].color = '#64748b'; sel.d30 = '--';
            } else {
                let d30Sum = 0;
                // ç”Ÿè‚²æœŸçº¿æ€§æ’å€¼Kcï¼ˆç®€åŒ–å®ç°ï¼šå–å½“å‰é˜¶æ®µå¯¹åº”Kcï¼‰
                const kc = kcConfig[currentStage.value] || 0.85;
                d30Window.forEach(h => {
                    const rainEff = (h.rain || 0) > 10 ? (h.rain * 0.85) : (h.rain || 0);
                    // åŠ¨æ€PETç®€åŒ–ç‰ˆï¼šè€ƒè™‘æ¸©åº¦ã€é£é€Ÿä¿®æ­£
                    const pet = (h.temp * 0.2) * (1 + (h.wind_speed || 0) * 0.1); 
                    d30Sum += (rainEff - pet * kc);
                });
                sel.d30 = d30Sum.toFixed(1) + 'mm';
                const isDrought = d30Sum < -70;
                risks.value[0].status = isDrought ? 'é‡åº¦å¹²æ—±' : 'é€‚å®œ';
                risks.value[0].color = isDrought ? '#ef4444' : '#10b981';
                if(isDrought) msgs.push({type:'diag-danger', text:'è§¦å‘é‡åº¦å¹²æ—±é¢„è­¦ï¼ŒD30æ°´åˆ†ä¸¥é‡äºç¼ºã€‚'});
            }

            // 2. é«˜æ¸©çƒ­å®³ä¸å¼ºå…‰æŸä¼¤ (å«å¹²çƒ­é£ä¿®æ­£) 
            const heatWindow = getPastData(3);
            const isT32 = heatWindow.length >= 3 && heatWindow.every(h => h.temp >= 32);
            // çƒ­å®³ç§¯åˆ†é€»è¾‘ï¼šT-32ï¼Œå¹²çƒ­é£(æ¹¿åº¦<30%)ç³»æ•°æå‡1.3
            let heatScore = 0;
            heatWindow.forEach(h => { if(h.temp >= 32) heatScore += (h.temp - 32) * (h.humidity < 30 ? 1.3 : 1.0); });
            
            const isUviScorching = (currentItem.uvi || 0) > 6 && (currentItem.clouds || 0) < 10;
            const hasHeatStress = isT32 || isUviScorching;
            risks.value[1].status = hasHeatStress ? 'æœ‰é£é™©' : 'æ­£å¸¸';
            risks.value[1].color = hasHeatStress ? '#ef4444' : '#10b981';
            if(isT32) msgs.push({type:'diag-danger', text:`æŒç»­é«˜æ¸©çƒ­å®³(ç§¯åˆ†:${heatScore.toFixed(1)})ã€‚`});
            if(isUviScorching) msgs.push({type:'diag-danger', text:'å¼ºå…‰ç¼ä¼¤é£é™©ï¼šUVI>6ä¸”äº‘é‡æä½ã€‚'});

            // 3. å¤§é£å€’ä¼æ¨¡å‹ (é£-é›¨-é˜¶æ®µ) 
            const rain24 = getPastData(24).reduce((a,c) => a + (c.rain||0), 0);
            const stageIdx = stageList.indexOf(currentStage.value);
            const stageFactor = stageIdx >= stageList.indexOf('V12å¤§å–‡å­å£') ? 1.5 : 1.0;
            const windDegRad = (currentItem.wind_deg || 0) * Math.PI / 180;
            const sideWindFix = 1 + 0.2 * Math.abs(Math.sin(windDegRad)); 
            const gust = currentItem.wind_gust || currentItem.wind_speed || 0;
            // æ¨¡å‹å…¬å¼ 
            const stress = gust * stageFactor * sideWindFix + (rain24 * 0.1); 
            const isWindRisk = stress > 15 || gust > 10.8;
            risks.value[3].status = isWindRisk ? 'é«˜é£é™©' : 'ä½é£é™©';
            risks.value[3].color = isWindRisk ? '#ef4444' : '#10b981';
            if(isWindRisk) msgs.push({type:'diag-danger', text:'å€’ä¼é¢„è­¦ï¼šé£é›¨ç»„åˆèƒè¿«ã€‚'});

            // 4. ä½æ¸©å†·å®³ (åˆ†ç”Ÿè‚²æœŸåˆ¤å®š) 
            if (stageIdx <= stageList.indexOf('V6æ‹”èŠ‚')) {
                const freezeWindow = getPastData(48);
                const isFreeze = freezeWindow.length >= 48 && freezeWindow.every(h => h.temp < 10);
                risks.value[2].status = isFreeze ? 'åƒµè‹—é£é™©' : 'æ­£å¸¸';
                risks.value[2].color = isFreeze ? '#ef4444' : '#10b981';
                if(isFreeze) msgs.push({type:'diag-danger', text:'è‹—æœŸæŒç»­ä½æ¸©ï¼Œåƒµè‹—é£é™©æé«˜ã€‚'});
            } else if (stageIdx <= stageList.indexOf('V12å¤§å–‡å­å£')) {
                const coolWindow = getPastData(24);
                const coolRatio = coolWindow.filter(h => h.temp < 18).length / coolWindow.length;
                const isCool = coolRatio > 0.8;
                risks.value[2].status = isCool ? 'æœç©—çŸ­å°' : 'æ­£å¸¸';
                risks.value[2].color = isCool ? '#ef4444' : '#10b981';
                if(isCool) msgs.push({type:'diag-warning', text:'æ‹”èŠ‚æœŸä½æ¸©å æ¯”è¶…80%ï¼Œå½±å“æœç©—åˆ†åŒ–ã€‚'});
            } else {
                risks.value[2].status = 'æ­£å¸¸'; risks.value[2].color = '#10b981';
            }

            // 5. æ´ªæ¶ä¸æ°´æ·¹ 
            const rain72 = getPastData(72).reduce((a,c) => a + (c.rain||0), 0);
            const isFlood = rain24 > 50 || rain72 > 150;
            risks.value[4].status = isFlood ? 'æœ‰é£é™©' : 'æ­£å¸¸';
            risks.value[4].color = isFlood ? '#ef4444' : '#10b981';
            if(isFlood) msgs.push({type:'diag-danger', text:'è§¦å‘æ´ªæ¶/æ°´æ·¹é¢„è­¦ã€‚'});

            // 6. æ— äººæœºæ‰“è¯é»„é‡‘çª—å£è¯„åˆ† 
            let flyScore = 100;
            const curGust = currentItem.wind_gust || currentItem.wind_speed || 0;
            // ç¡¬çº¢çº¿åˆ¤å®š
            if(curGust > 8 || currentItem.temp > 35 || currentItem.humidity < 30) {
                flyScore = 0;
            } else {
                if(currentItem.temp - (currentItem.dew_point||0) < 2.5) flyScore -= 25; // éœ²æ°´æ‰£åˆ†
                if((currentItem.uvi||0) > 5) flyScore -= 15; // å¼ºå…‰æ‰£åˆ†
                if(currentItem.temp > 30) flyScore -= 20; // é«˜æ¸©è’¸å‘æ‰£åˆ†
            }
            risks.value[6].status = flyScore + 'åˆ†';
            risks.value[6].color = flyScore >= 70 ? '#10b981' : (flyScore >= 40 ? '#f59e0b' : '#ef4444');

            // 7. ç—…è™«å®³é¢„è­¦çŸ©é˜µ 
            let pests = [];
            // å¤§æ–‘ç—…ï¼šV12-R4, 20-25â„ƒ, æ¹¿åº¦>90%
            if (stageIdx >= stageList.indexOf('V12å¤§å–‡å­å£') && stageIdx <= stageList.indexOf('R4èœ¡ç†Ÿ')) {
                if (currentItem.temp >= 20 && currentItem.temp <= 25 && currentItem.humidity > 90) pests.push('å¤§æ–‘ç—…');
            }
            // çº¢èœ˜è››ï¼šå¹²æ—±(D30<-50) + é«˜æ¸©(T>32)
            if (parseFloat(sel.d30) < -50 && currentItem.temp > 32) pests.push('çº¢èœ˜è››');
            // ç‰ç±³èŸï¼šV12/VT, æ¹¿åº¦>70%
            if ((stageIdx === stageList.indexOf('V12å¤§å–‡å­å£') || stageIdx === stageList.indexOf('VTæŠ½ç©—')) && currentItem.humidity > 70) pests.push('ç‰ç±³èŸ');

            risks.value[5].status = pests.length > 0 ? pests.join('/') : 'å¹³ç¨³';
            risks.value[5].color = pests.length > 0 ? '#f59e0b' : '#10b981';
            if(pests.length > 0) msgs.push({type:'diag-warning', text: `é«˜å‘æœŸé¢„è­¦ï¼š${pests.join('ã€')}ã€‚`});

            diagMsgs.value = msgs;
        };

        const updateDetail = (r) => {
            if (!r) return;
            Object.assign(sel, { 
                temp: r.temp, 
                rain: r.rain, 
                wind_speed: r.wind_speed, 
                wind_gust: r.wind_gust,
                dir: getWindDirText(r.wind_deg), 
                wind_deg: r.wind_deg, 
                humidity: r.humidity, 
                pressure: r.pressure, 
                dew_point: r.dew_point, 
                weather_desc: r.weather_desc, 
                uvi: r.uvi, 
                visibility: r.visibility, 
                clouds: r.clouds, 
                snow: r.snow,
                flag_desc: r.flag === 1 ? 'æœªæ¥é¢„æµ‹' : 'å†å²å®å†µ', 
                time: r.time, 
                date: r.date 
            });
            const b = getBeaufort(r.wind_speed);
            sel.wf = b !== null ? b + 'çº§' : '--'; 
        };

        const resetToRealtime = () => {
            if (isLocked.value) return;
            const h = realtimeMap.value[selectedId.value] || [];
            if(h.length > 0) { 
                const last = h[h.length - 1];
                updateDetail(last); judgeRisks(last); 
            }
        };

        const loadData = async () => {
            try {
                const ts = `?t=${Date.now()}`;
                const [tRes, rRes, fRes] = await Promise.all([ 
                    axios.get(`${base}/towns.csv${ts}`), 
                    axios.get(`${base}/2026.json${ts}`), 
                    axios.get(`${base}/forecasts.json${ts}`)
                ]);
                
                towns.value = tRes.data.split('\n').slice(1).filter(r => r.includes(',')).map(r => ({ name: r.split(',')[1].trim(), id: r.split(',')[2].trim() }));
                realtimeMap.value = typeof rRes.data === 'string' ? JSON.parse(rRes.data) : rRes.data; 
                forecastMap.value = typeof fRes.data === 'string' ? JSON.parse(fRes.data) : fRes.data;
                
                if(towns.value.length > 0) { 
                    isConnected.value = true; 
                    selectedId.value = towns.value[0].id; 
                }
            } catch (e) { 
                console.error("åŒæ­¥å¤±è´¥:", e);
                isConnected.value = false; 
            }
        };

        watch(selectedId, (id) => { 
            isLocked.value = false; 
            renderChart(forecastMap.value[id] || []); 
            resetToRealtime(); 
        });
        watch(currentStage, resetToRealtime);
        onMounted(loadData);
        return { towns, selectedId, stageList, currentStage, isConnected, isLocked, risks, sel, diagMsgs, calDays, viewYear, viewMonth, clickCalDate, hasManualLock, showFixModal, fixDate, saveManualFix };
    }
}).mount('#app');
</script>
</body>
</html>
